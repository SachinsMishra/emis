WITH LatestIndicators AS (
    SELECT
        BTFL.ACCOUNT_NUMBER,
        BTFL.CLASIFICATION_DOMAIN_REG_NO,
        MAX(BTFL.FROM_DATE) AS LatestFromDate
    FROM
        FDW_DEV13.DimAccountClassificationVc BTFL
    WHERE
        BTFL.CLASIFICATION_DOMAIN_REG_NO IN ('4012001', '4012006', '4012011')
        AND BTFL.ACCOUNT_NUMBER = '07800G4S7' -- Add more account numbers here if needed
    GROUP BY
        BTFL.ACCOUNT_NUMBER, BTFL.CLASIFICATION_DOMAIN_REG_NO
)

SELECT
    BTFL.ACCOUNT_NUMBER,
    BTFL.CLASIFICATION_DOMAIN_REG_NO,
    BTFL.ACCOUNT_SYSTEM_REG_NO,
    COALESCE(BTFL.CLASSIFICATION_NAME, PrevClassifications.CLASSIFICATION_NAME) AS BankingTradingClassification,
    COALESCE(BTFL.FROM_DATE, PrevClassifications.FROM_DATE) AS FROM_DATE,
    COALESCE(BTFL.TO_DATE, PrevClassifications.TO_DATE) AS TO_DATE
FROM
    FDW_DEV13.DimAccountClassificationVc BTFL
LEFT JOIN
    LatestIndicators LI ON BTFL.ACCOUNT_NUMBER = LI.ACCOUNT_NUMBER
    AND BTFL.CLASIFICATION_DOMAIN_REG_NO = LI.CLASIFICATION_DOMAIN_REG_NO
LEFT JOIN
    FDW_DEV13.DimAccountClassificationVc PrevClassifications
ON
    BTFL.ACCOUNT_NUMBER = PrevClassifications.ACCOUNT_NUMBER
    AND BTFL.CLASIFICATION_DOMAIN_REG_NO = PrevClassifications.CLASIFICATION_DOMAIN_REG_NO
    AND LI.LatestFromDate = PrevClassifications.FROM_DATE
WHERE
    BTFL.CLASIFICATION_DOMAIN_REG_NO IN ('4012001', '4012006', '4012011')
    AND BTFL.ACCOUNT_NUMBER = '07800G4S7'; -- Add more account numbers here if needed

